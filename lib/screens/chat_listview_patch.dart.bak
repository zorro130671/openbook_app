return ListView.builder(
  padding: const EdgeInsets.all(8),
  itemCount: messages.length,
  itemBuilder: (context, index) {
    final message = messages[index].data()! as Map<String, dynamic>;
    final timestamp = (messages[index]['timestamp'] as Timestamp).toDate();
    final isMe = message["senderId"] == widget.currentUser.uid;

    final currentDate = DateTime(timestamp.year, timestamp.month, timestamp.day);
    final previousDate = index > 0
        ? DateTime(
            (messages[index - 1]['timestamp'] as Timestamp).toDate().year,
            (messages[index - 1]['timestamp'] as Timestamp).toDate().month,
            (messages[index - 1]['timestamp'] as Timestamp).toDate().day,
          )
        : null;

    String? header;
    final now = DateTime.now();
    if (previousDate != currentDate) {
      if (currentDate == DateTime(now.year, now.month, now.day)) {
        header = "Today";
      } else if (currentDate == DateTime(now.year, now.month, now.day - 1)) {
        header = "Yesterday";
      } else {
        header = "${currentDate.day}/${currentDate.month}/${currentDate.year}";
      }
    }

    return Column(
      crossAxisAlignment: CrossAxisAlignment.center,
      children: [
        if (header != null)
          Padding(
            padding: const EdgeInsets.symmetric(vertical: 10),
            child: Text(
              header,
              style: const TextStyle(
                color: Colors.white54,
                fontSize: 12,
                fontWeight: FontWeight.w500,
              ),
            ),
          ),
        Container(
          alignment: isMe ? Alignment.centerRight : Alignment.centerLeft,
          margin: const EdgeInsets.symmetric(vertical: 4),
          child: Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: isMe ? Colors.blue[700] : Colors.grey[800],
              borderRadius: BorderRadius.circular(8),
            ),
            child: Text(
              message["text"] ?? "",
              style: TextStyle(
                color: isMe ? Colors.white : Colors.white70,
              ),
            ),
          ),
        ),
      ],
    );
  },
);
